<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Monitor Dashboard</title>
    
    <!-- Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Chart Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: #f5f7fa;
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
        }
        
        header h1 {
            font-size: 2rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        
        header h1 i {
            color: #e74c3c;
        }
        
        header p {
            color: #7f8c8d;
            font-size: 0.95rem;
        }
        
        .device-badge {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .heart-rate, .sleep-level {
            grid-column: span 1;
        }
        
        .gps {
            grid-column: span 2;
        }
        
        .data-history {
            grid-column: span 4;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }
        
        .card-title {
            font-size: 1.3rem;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }
        
        .card-title i {
            font-size: 1.5rem;
        }
        
        .heart-rate .card-title i {
            color: #e74c3c;
        }
        
        .sleep-level .card-title i {
            color: #3498db;
        }
        
        .gps .card-title i {
            color: #27ae60;
        }
        
        .card-value {
            font-size: 3.5rem;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
            color: #2c3e50;
        }
        
        .heart-rate .card-value {
            color: #e74c3c;
        }
        
        .sleep-level .card-value {
            color: #3498db;
        }
        
        .card-subtitle {
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .status-normal {
            background: #d5f4e6;
            color: #27ae60;
        }
        
        .status-light {
            background: #fff3cd;
            color: #f39c12;
        }
        
        .status-medium {
            background: #ffe5cc;
            color: #e67e22;
        }
        
        .status-heavy {
            background: #fadbd8;
            color: #e74c3c;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        /* GPS Card yang lebih besar */
        .gps .map-container {
            height: 320px; /* Tinggi peta diperbesar */
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #ecf0f1;
            margin-top: 15px;
        }
        
        .coordinates {
            display: flex;
            justify-content: space-around;
            background: #f8f9fa;
            padding: 20px; /* Padding diperbesar */
            border-radius: 10px;
            margin-top: 20px;
            font-size: 1.1rem; /* Font size diperbesar */
        }
        
        .coord-item {
            text-align: center;
            flex: 1;
        }
        
        .coord-label {
            font-size: 0.9rem; /* Sedikit lebih besar */
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .coord-value {
            font-family: 'Courier New', monospace;
            font-weight: 700; /* Lebih tebal */
            color: #2c3e50;
            font-size: 1.2rem; /* Lebih besar */
        }
        
        .chart-container {
            margin-top: 20px;
            height: 220px;
            position: relative;
        }
        
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border-radius: 10px;
            border: 1px solid #ecf0f1;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 10;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            font-size: 0.9rem;
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9rem;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .status-bar {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-connected {
            background: #27ae60;
        }
        
        .status-disconnected {
            background: #e74c3c;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        .loading i {
            font-size: 2.5rem;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .stats-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #ecf0f1;
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        
        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .gps {
                grid-column: span 2;
            }
            
            .data-history {
                grid-column: span 2;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .heart-rate, .sleep-level, .gps, .data-history {
                grid-column: 1;
            }
            
            header h1 {
                font-size: 1.5rem;
            }
            
            .card-value {
                font-size: 2.8rem;
            }
            
            .gps .map-container {
                height: 250px; /* Tinggi peta di mobile */
            }
            
            .coordinates {
                padding: 15px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-heartbeat"></i> Health Monitor Dashboard</h1>
            <p>Real-time monitoring sistem kesehatan</p>
            <div class="device-badge">Device: <span id="deviceId">HM2025</span></div>
        </header>
        
        <div class="dashboard">
            <!-- Heart Rate Card -->
            <div class="card heart-rate">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-heart"></i> Detak Jantung</h2>
                    <span class="status-badge status-normal" id="heartStatus">Normal</span>
                </div>
                <div class="card-value" id="bpmValue">--</div>
                <div class="card-subtitle">Beats per Minute (BPM)</div>
                
                <div class="chart-container">
                    <canvas id="bpmChart"></canvas>
                </div>
            </div>
            
            <!-- Sleep Level Card -->
            <div class="card sleep-level">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-moon"></i> Tingkat Kantuk</h2>
                </div>
                <div class="card-value" id="sleepValue">--</div>
                <div style="text-align: center; margin-top: 15px;">
                    <span class="status-badge status-normal" id="sleepStatus">
                        <span class="status-indicator status-connected"></span>
                        Menunggu data...
                    </span>
                </div>
            </div>
            
            <!-- GPS Location Card - DOUBLE SIZE -->
            <div class="card gps">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-map-marker-alt"></i> Lokasi GPS</h2>
                    <span id="gpsStatus" style="color: #7f8c8d; font-size: 0.85rem;">Menunggu...</span>
                </div>
                
                <div class="map-container" id="map"></div>
                
                <div class="coordinates">
                    <div class="coord-item">
                        <div class="coord-label">Latitude</div>
                        <div class="coord-value" id="latitude">--</div>
                    </div>
                    <div class="coord-item">
                        <div class="coord-label">Longitude</div>
                        <div class="coord-value" id="longitude">--</div>
                    </div>
                </div>
            </div>
            
            <!-- Data History Card -->
            <div class="card data-history">
                <div class="card-header">
                    <h2 class="card-title"><i class="fas fa-history"></i> Riwayat Data</h2>
                    <div style="display: flex; gap: 10px;">
                        <button id="refreshBtn" class="btn btn-primary">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button id="clearBtn" class="btn btn-danger">
                            <i class="fas fa-trash"></i> Hapus
                        </button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Waktu</th>
                                <th>BPM</th>
                                <th>Kantuk</th>
                                <th>Lokasi</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="4" class="loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Memuat data dari Firebase...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="stats-footer">
                    <div>Total: <strong id="totalCount">0</strong> data</div>
                    <div>Tampil: <strong id="displayCount">0</strong> data</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <span class="status-dot status-connected" id="statusDot"></span>
        <span id="statusText">Menghubungkan...</span>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Firebase SDK v12 (Modular) -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
        import { 
            getDatabase, 
            ref, 
            onValue, 
            onChildAdded, 
            remove, 
            get 
        } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
        
        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBwOb4c1tnabVuFgVUdPrB8wO9xcT0U5BY",
            authDomain: "ngantuk-c3a69.firebaseapp.com",
            databaseURL: "https://ngantuk-c3a69-default-rtdb.firebaseio.com",
            projectId: "ngantuk-c3a69",
            storageBucket: "ngantuk-c3a69.firebasestorage.app",
            messagingSenderId: "244338996972",
            appId: "1:244338996972:web:abdf3d970004287bbc17c9"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        
        // Global variables
        let map, marker, bpmChart;
        let allRecords = [];
        const deviceId = "HM2025";
        
        // Initialize Map
        function initMap() {
            map = L.map('map').setView([-6.9175, 107.6191], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);
            marker = L.marker([-6.9175, 107.6191]).addTo(map);
        }
        
        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('bpmChart').getContext('2d');
            bpmChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'BPM',
                        data: [],
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            ticks: { maxTicksLimit: 10 }
                        },
                        y: {
                            beginAtZero: false,
                            suggestedMin: 40,
                            suggestedMax: 120
                        }
                    }
                }
            });
        }
        
        // Update Chart from Records
        function updateChart() {
            const chartData = allRecords.slice(0, 20).reverse();
            const labels = chartData.map(r => {
                const d = new Date(r.timestamp);
                return d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            });
            const data = chartData.map(r => r.bpm || 0);
            
            bpmChart.data.labels = labels;
            bpmChart.data.datasets[0].data = data;
            bpmChart.update('none');
        }
        
        // Update Table
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            
            if (allRecords.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="loading">
                            <i class="fas fa-database"></i>
                            <p>Tidak ada data</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            const displayData = allRecords.slice(0, 50);
            let html = '';
            
            displayData.forEach(record => {
                const date = new Date(record.timestamp);
                const time = date.toLocaleString('id-ID', {
                    day: '2-digit',
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const sleepText = ['Normal', 'Ringan', 'Sedang', 'Berat'][record.tingkat_ngantuk] || '--';
                const sleepColor = ['#27ae60', '#f39c12', '#e67e22', '#e74c3c'][record.tingkat_ngantuk] || '#7f8c8d';
                
                const location = (record.latitude && record.longitude && record.latitude !== 0) 
                    ? `${record.latitude.toFixed(4)}, ${record.longitude.toFixed(4)}`
                    : 'Tidak tersedia';
                
                html += `
                    <tr>
                        <td>${time}</td>
                        <td><strong>${record.bpm || '--'}</strong></td>
                        <td><span style="color: ${sleepColor}; font-weight: 600;">${sleepText}</span></td>
                        <td style="font-family: monospace; font-size: 0.85rem;">${location}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
            document.getElementById('totalCount').textContent = allRecords.length;
            document.getElementById('displayCount').textContent = displayData.length;
        }
        
        // Update Real-time Display
        function updateDisplay(data) {
            // BPM
            if (data.bpm) {
                document.getElementById('bpmValue').textContent = data.bpm;
                
                const heartStatus = document.getElementById('heartStatus');
                if (data.bpm < 60) {
                    heartStatus.textContent = 'Rendah';
                    heartStatus.className = 'status-badge status-light';
                } else if (data.bpm <= 100) {
                    heartStatus.textContent = 'Normal';
                    heartStatus.className = 'status-badge status-normal';
                } else {
                    heartStatus.textContent = 'Tinggi';
                    heartStatus.className = 'status-badge status-heavy';
                }
            }
            
            // Sleep Level
            if (data.tingkat_ngantuk !== undefined) {
                document.getElementById('sleepValue').textContent = data.tingkat_ngantuk;
                
                const sleepStatus = document.getElementById('sleepStatus');
                const texts = ['Normal', 'Ringan', 'Sedang', 'Berat'];
                const classes = ['status-normal', 'status-light', 'status-medium', 'status-heavy'];
                
                sleepStatus.innerHTML = `
                    <span class="status-indicator ${data.tingkat_ngantuk >= 2 ? 'status-disconnected' : 'status-connected'}"></span>
                    ${texts[data.tingkat_ngantuk] || 'Unknown'}
                `;
                sleepStatus.className = 'status-badge ' + (classes[data.tingkat_ngantuk] || 'status-normal');
            }
            
            // GPS
            if (data.latitude && data.longitude && data.latitude !== 0) {
                marker.setLatLng([data.latitude, data.longitude]);
                map.setView([data.latitude, data.longitude], 13);
                document.getElementById('latitude').textContent = data.latitude.toFixed(6);
                document.getElementById('longitude').textContent = data.longitude.toFixed(6);
                document.getElementById('gpsStatus').innerHTML = '<span style="color: #27ae60;"><i class="fas fa-check-circle"></i> Aktif</span>';
            }
        }
        
        // Load All Records
        async function loadRecords() {
            try {
                const recordsRef = ref(database, `devices/${deviceId}/records`);
                const snapshot = await get(recordsRef);
                allRecords = [];
                
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const data = child.val();
                        data.timestamp = parseInt(child.key);
                        allRecords.push(data);
                    });
                    
                    allRecords.sort((a, b) => b.timestamp - a.timestamp);
                    
                    updateTable();
                    updateChart();
                    
                    if (allRecords.length > 0) {
                        updateDisplay(allRecords[0]);
                    }
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }
        
        // Update Status
        function updateStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.className = 'status-dot status-connected';
                text.textContent = 'Terhubung ke Firebase';
            } else {
                dot.className = 'status-dot status-disconnected';
                text.textContent = 'Terputus dari Firebase';
            }
        }
        
        // Clear All Data
        async function clearData() {
            if (confirm('Hapus semua data dari Firebase?')) {
                try {
                    const recordsRef = ref(database, `devices/${deviceId}/records`);
                    await remove(recordsRef);
                    allRecords = [];
                    updateTable();
                    updateChart();
                } catch (error) {
                    console.error('Error clearing data:', error);
                }
            }
        }
        
        // Initialize on Load
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initChart();
            loadRecords();
            
            // Event Listeners
            document.getElementById('refreshBtn').addEventListener('click', loadRecords);
            document.getElementById('clearBtn').addEventListener('click', clearData);
            
            // Real-time Listener for New Data
            const recordsRef = ref(database, `devices/${deviceId}/records`);
            
            // Listen for new child added
            onChildAdded(recordsRef, (snapshot) => {
                const newData = snapshot.val();
                newData.timestamp = parseInt(snapshot.key);
                
                // Check if this is truly new data
                const exists = allRecords.some(r => r.timestamp === newData.timestamp);
                if (!exists) {
                    allRecords.unshift(newData);
                    updateTable();
                    updateChart();
                    updateDisplay(newData);
                    console.log('New data received:', newData);
                }
            });
            
            // Connection Status Monitor
            const connectedRef = ref(database, '.info/connected');
            onValue(connectedRef, (snapshot) => {
                updateStatus(snapshot.val() === true);
            });
        });
        
        // Handle Window Resize
        window.addEventListener('resize', () => {
            if (map) map.invalidateSize();
        });
    </script>
</body>
</html>
